<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>UBike 2.0 Á´ôÈªûÁõ£Êéß</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVUJpa2UgMi4wIOermOmBuOeboeaOp+WZqCIsInNob3J0X25hbWUiOiJVQmlrZSDnm6HmjqciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzI1NjNlYiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdkbWxsZDBKdmVEMGlNQ0F3SURFME5DQXhORFFpSUdobGJXNXpQU0pvZEhSd2N6b3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4d1lYUm9JR1E5SW0wME1TNHhOemczTGpNeU9EQXVNREkzTGpVMU5ERXdMamMzTVRreE9TNDJOemcyTVRBdU56Y3hPUzQzTkRrM09TNHhOalU1T0M0eE5qVTVPQzQwTnpZMk1UQXVORGszTnpBdU1UYzFPVGszTGpNeU9EUXVNREkzZXlJZ1ptbHNiRDBpSXpJMU5qTmxZaUl2UGp4d1lYUm9JR1E5SW0wNU1pNDVOell5T0RBdU1ESTNMakUwTVRrd01TNHdPRE14TnpBdU1UYzFPVGsyTGprNU16WTRPUzR4TkRFNU1qQXVNRGswTWpBdU1EazBNakF1TWpreE56Y3VNekEzWmpFM0xqTXdObVExTWk0ek5EVTFPREZ1TWpRdU1qYzJNVEl4TGpjNE56YzFNakkxTGpnek1EVTFPREF1TURJM2VpSWdabWxzYkQwaUl6WmlabU16WmlJdlBqeHdZWFJvSUdROUltMHhNRE11TkRBeE1qQXVNRGs1TXpjdU9UUXlNekEzTGpNME5qWkVPRFF1TkRJek1qQXVNREkzVWpBdU1ESTNNRE11TkRBeGVpSWdabWxzYkQwaUkwWkdSa1pHUmlJdlBqd3ZjM1puUGc9PSIsInNpemVzIjoiMTQ0eDE0NCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- Á¶ÅÊ≠¢Á∏ÆÊîæ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header .subtitle {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .container {
            flex: 1;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
        }
        
        .search-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .search-input {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
        }
        
        .search-input::placeholder {
            color: #666;
        }
        
        .search-btn {
            width: 100%;
            padding: 16px;
            background: #10b981;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16,185,129,0.3);
        }
        
        .search-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        .station-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .station-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .station-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .info-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 16px;
            border-radius: 12px;
        }
        
        .info-number {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .info-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .bikes-available {
            color: #10b981;
        }
        
        .spaces-available {
            color: #3b82f6;
        }
        
        .station-address {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }
        
        .error {
            background: rgba(239,68,68,0.9);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.8;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .last-update {
            text-align: center;
            opacity: 0.6;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: #10b981;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(16,185,129,0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(16,185,129,0.5);
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .station-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö≤ UBike 2.0 Áõ£Êéß</h1>
        <div class="subtitle">Êñ∞ÂåóÂ∏ÇÂÖ¨ÂÖ±Ëá™Ë°åËªäÂç≥ÊôÇË≥áË®ä</div>
    </div>
    
    <div class="container">
        <div class="search-section">
            <input type="text" class="search-input" id="stationSearch" placeholder="Ëº∏ÂÖ•Á´ôÈªûÂêçÁ®± (‰æãÂ¶Ç: ÊùøÊ©ãËªäÁ´ô)">
            <button class="search-btn" onclick="searchStation()">üîç ÊêúÂ∞ãÁ´ôÈªû</button>
            
            <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="testAPI()" style="
                    flex: 1;
                    padding: 12px;
                    background: #3b82f6;
                    border: none;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    cursor: pointer;
                ">üîß Ê∏¨Ë©¶APIÈÄ£Á∑ö</button>
                
                <button onclick="showSolutions()" style="
                    flex: 1;
                    padding: 12px;
                    background: #f59e0b;
                    border: none;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    cursor: pointer;
                ">üí° Êü•ÁúãËß£Ê±∫ÊñπÊ°à</button>
            </div>
            
            <div style="margin-top: 12px;">
                <input type="text" placeholder="Â¶ÇÊûú‰Ω†ÊúâËá™Â∑±ÁöÑAPIÁ∂≤ÂùÄÔºåË´ãËº∏ÂÖ•..." id="customApiUrl" style="
                    width: 70%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px 0 0 6px;
                    font-size: 14px;
                ">
                <button onclick="setCustomAPI()" style="
                    width: 30%;
                    padding: 10px;
                    background: #10b981;
                    border: none;
                    border-radius: 0 6px 6px 0;
                    color: white;
                    font-size: 14px;
                    cursor: pointer;
                ">Ë®≠ÂÆö</button>
            </div>
        </div>
        
        <div id="results"></div>
    </div>
    
    <button class="refresh-btn" onclick="refreshData()" title="ÈáçÊñ∞Êï¥ÁêÜ">
        <span id="refreshIcon">üîÑ</span>
    </button>
    
    <script>
        let currentStations = [];
        let lastSearchKeyword = '';
        
        // ÊêúÂ∞ãÁ´ôÈªû
        async function searchStation() {
            const keyword = document.getElementById('stationSearch').value.trim();
            if (!keyword) {
                showError('Ë´ãËº∏ÂÖ•Á´ôÈªûÂêçÁ®±');
                return;
            }
            
            lastSearchKeyword = keyword;
            await fetchStationData(keyword);
        }
        
        // ÈáçÊñ∞Êï¥ÁêÜË≥áÊñô
        async function refreshData() {
            if (!lastSearchKeyword) return;
            
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            await fetchStationData(lastSearchKeyword);
            
            setTimeout(() => {
                refreshIcon.style.animation = '';
            }, 1000);
        }
        
        // Áç≤ÂèñÁ´ôÈªûË≥áÊñô (ÊîØÊè¥Ëá™Ë®ÇAPI)
        async function fetchStationData(keyword) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    ÊêúÂ∞ã‰∏≠...
                </div>
            `;
            
            try {
                let data;
                let response;
                let apiUrl;
                
                // ÂÑ™ÂÖà‰ΩøÁî®Ëá™Ë®ÇAPI
                if (window.customApiUrl) {
                    apiUrl = window.customApiUrl;
                    console.log('‰ΩøÁî®Ëá™Ë®ÇAPI:', apiUrl);
                }
                // ÂÖ∂Ê¨°‰ΩøÁî®ÊâæÂà∞ÁöÑÂèØÁî®API
                else if (window.workingApiUrl) {
                    apiUrl = window.workingApiUrl;
                    console.log('‰ΩøÁî®Ê∏¨Ë©¶ÈÄöÈÅéÁöÑAPI:', apiUrl);
                }
                // ÊúÄÂæåÂòóË©¶Áõ¥Êé•Ë®™Âïè
                else {
                    apiUrl = 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json';
                    console.log('ÂòóË©¶Áõ¥Êé•APIË®™Âïè:', apiUrl);
                }
                
                response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Á¢∫‰øùdataÊòØÈô£ÂàóÊ†ºÂºè
                if (!Array.isArray(data)) {
                    throw new Error('APIÂõûÊáâÊ†ºÂºè‰∏çÊ≠£Á¢∫ - ÈúÄË¶ÅÈô£ÂàóÊ†ºÂºè');
                }
                
                console.log(`ÊàêÂäüÁç≤Âèñ ${data.length} Á≠ÜÁ´ôÈªûË≥áÊñô`);
                
                // ÁØ©ÈÅ∏ÂåÖÂê´ÈóúÈçµÂ≠óÁöÑÁ´ôÈªû
                const filteredStations = data.filter(station => 
                    station.sna && station.sna.includes(keyword)
                );
                
                currentStations = filteredStations;
                displayStations(filteredStations);
                
            } catch (error) {
                console.error('API Error:', error);
                
                // Ê†πÊìöÈåØË™§È°ûÂûãÈ°ØÁ§∫‰∏çÂêåÁöÑËß£Ê±∫Âª∫Ë≠∞
                let errorMessage = '';
                let suggestions = '';
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    errorMessage = 'CORSË∑®ÂüüÈôêÂà∂ÊàñÁ∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å';
                    suggestions = `
                        <strong>üí° Âª∫Ë≠∞Ëß£Ê±∫ÊñπÊ°àÔºö</strong><br>
                        1. ÈªûÈÅ∏„Äåüí° Êü•ÁúãËß£Ê±∫ÊñπÊ°à„Äç‰∫ÜËß£Ë©≥Á¥∞Ë™™Êòé<br>
                        2. ‰ΩøÁî®VercelÁ≠âÊúçÂãôÈÉ®ÁΩ≤Ëá™Â∑±ÁöÑAPI‰ª£ÁêÜ<br>
                        3. Êö´ÊôÇ‰ΩøÁî®Ê∏¨Ë©¶Ë≥áÊñôÈ´îÈ©óÂäüËÉΩ
                    `;
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `API‰º∫ÊúçÂô®ÂõûÊáâÈåØË™§: ${error.message}`;
                    suggestions = `
                        <strong>üí° ÂèØËÉΩÂéüÂõ†Ôºö</strong><br>
                        ‚Ä¢ API‰º∫ÊúçÂô®Êö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®<br>
                        ‚Ä¢ Á∂≤ÂùÄË®≠ÂÆö‰∏çÊ≠£Á¢∫<br>
                        ‚Ä¢ APIÊ†ºÂºèÂ∑≤ËÆäÊõ¥
                    `;
                } else {
                    errorMessage = error.message;
                    suggestions = 'Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñAPIË®≠ÂÆö';
                }
                
                showError(`
                    <strong>üö´ ÁÑ°Ê≥ïÁç≤ÂèñÂç≥ÊôÇË≥áÊñô</strong><br><br>
                    ÈåØË™§ÂéüÂõ†: ${errorMessage}<br><br>
                    ${suggestions}<br><br>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;">
                        <button onclick="showSolutions()" style="
                            background: #f59e0b; 
                            color: white; 
                            border: none; 
                            padding: 10px 16px; 
                            border-radius: 6px; 
                            cursor: pointer;
                            font-size: 13px;
                        ">üí° Êü•ÁúãËß£Ê±∫ÊñπÊ°à</button>
                        
                        <button onclick="useTestData('${keyword}')" style="
                            background: #10b981; 
                            color: white; 
                            border: none; 
                            padding: 10px 16px; 
                            border-radius: 6px; 
                            cursor: pointer;
                            font-size: 13px;
                        ">üß™ ‰ΩøÁî®Ê∏¨Ë©¶Ë≥áÊñô</button>
                    </div>
                `);
            }
        }
        
        // ‰ΩøÁî®Ê∏¨Ë©¶Ë≥áÊñô
        function useTestData(keyword) {
            const data = generateTestData(keyword);
            const filteredStations = data.filter(station => 
                station.sna && station.sna.includes(keyword)
            );
            
            currentStations = filteredStations;
            displayStations(filteredStations);
        }
        
        // ÁîüÊàêÊ∏¨Ë©¶Ë≥áÊñô (Ê®°Êì¨ÁúüÂØ¶API)
        function generateTestData(keyword) {
            const testStations = [
                {
                    sno: "500101001",
                    sna: "YouBike2.0_ÊùøÊ©ãËªäÁ´ô",
                    tot: 40,
                    sbi: 12,
                    bemp: 28,
                    sarea: "ÊùøÊ©ãÂçÄ",
                    ar: "Êñ∞ÂåóÂ∏ÇÊùøÊ©ãÂçÄÁ∏£Ê∞ëÂ§ßÈÅì‰∫åÊÆµ7Ëôü(ÊùøÊ©ãËªäÁ´ô)",
                    act: "1"
                },
                {
                    sno: "500101002", 
                    sna: "YouBike2.0_Êñ∞ÂüîÁ´ô1ËôüÂá∫Âè£",
                    tot: 32,
                    sbi: 8,
                    bemp: 24,
                    sarea: "ÊùøÊ©ãÂçÄ",
                    ar: "Êñ∞ÂåóÂ∏ÇÊùøÊ©ãÂçÄÊ∞ëÁîüË∑Ø‰∏âÊÆµ17ËôüÂâçÊñπ",
                    act: "1"
                },
                {
                    sno: "500101003",
                    sna: "YouBike2.0_Â∫ú‰∏≠Á´ô",
                    tot: 28,
                    sbi: 5,
                    bemp: 23,
                    sarea: "ÊùøÊ©ãÂçÄ", 
                    ar: "Êñ∞ÂåóÂ∏ÇÊùøÊ©ãÂçÄÂ∫ú‰∏≠Ë∑Ø29ËôüÂ∞çÈù¢",
                    act: "1"
                },
                {
                    sno: "500101004",
                    sna: "YouBike2.0_‰∏âÈáçÁ´ô",
                    tot: 36,
                    sbi: 15,
                    bemp: 21,
                    sarea: "‰∏âÈáçÂçÄ",
                    ar: "Êñ∞ÂåóÂ∏Ç‰∏âÈáçÂçÄÈáçÊñ∞Ë∑ØÂõõÊÆµ17ËôüÂâç",
                    act: "1"
                },
                {
                    sno: "500101005",
                    sna: "YouBike2.0_Êñ∞ËéäÁ´ô",
                    tot: 30,
                    sbi: 7,
                    bemp: 23,
                    sarea: "Êñ∞ËéäÂçÄ",
                    ar: "Êñ∞ÂåóÂ∏ÇÊñ∞ËéäÂçÄÊñ∞Ê®πË∑Ø108ËôüÂ∞çÈù¢",
                    act: "1"
                }
            ];
            
            return testStations;
        }
        
        // Ê∏¨Ë©¶APIÈÄ£Á∑ö
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Ê≠£Âú®Ê∏¨Ë©¶APIÈÄ£Á∑ö...
                </div>
            `;
            
            const apiUrls = [
                {
                    name: 'Êñ∞ÂåóÂ∏ÇÂÆòÊñπAPI',
                    url: 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json'
                },
                {
                    name: 'ÊîøÂ∫úË≥áÊñôÈñãÊîæÂπ≥Âè∞',
                    url: 'https://data.gov.tw/api/v1/rest/datastore/382000000A-000352-001'
                },
                {
                    name: 'YouBikeÂÆòÊñπAPI',
                    url: 'https://apis.youbike.com.tw/json/station-yb2.json'
                }
            ];
            
            let testResults = '<div class="station-card"><h3>üîß APIÈÄ£Á∑öÊ∏¨Ë©¶ÁµêÊûú</h3><br>';
            
            for (const api of apiUrls) {
                try {
                    console.log(`Ê∏¨Ë©¶ ${api.name}: ${api.url}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ÁßíË∂ÖÊôÇ
                    
                    const response = await fetch(api.url, {
                        signal: controller.signal,
                        mode: 'cors',
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const status = response.status;
                    const statusText = response.statusText;
                    
                    if (response.ok) {
                        const data = await response.json();
                        const dataLength = Array.isArray(data) ? data.length : Object.keys(data).length;
                        
                        testResults += `
                            <div style="background: rgba(16,185,129,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #10b981;">
                                <strong>‚úÖ ${api.name}</strong><br>
                                ÁãÄÊÖã: ${status} ${statusText}<br>
                                Ë≥áÊñôÁ≠ÜÊï∏: ${dataLength}<br>
                                <small style="opacity: 0.8;">${api.url}</small>
                            </div>
                        `;
                        
                        // Â¶ÇÊûúÊàêÂäüÔºå‰ΩøÁî®ÈÄôÂÄãAPI
                        if (Array.isArray(data) && data.length > 0) {
                            console.log(`‚úÖ ÊâæÂà∞ÂèØÁî®ÁöÑAPI: ${api.name}`);
                            window.workingApiUrl = api.url;
                        }
                    } else {
                        throw new Error(`HTTP ${status}: ${statusText}`);
                    }
                } catch (error) {
                    console.error(`‚ùå ${api.name} Â§±Êïó:`, error);
                    
                    let errorMsg = error.message;
                    if (error.name === 'AbortError') {
                        errorMsg = 'Ë´ãÊ±ÇË∂ÖÊôÇ (5Áßí)';
                    } else if (error.message.includes('CORS')) {
                        errorMsg = 'CORSË∑®ÂüüÈôêÂà∂';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMsg = 'Á∂≤Ë∑ØÈÄ£Á∑öÂ§±ÊïóÊàñCORSÈôêÂà∂';
                    }
                    
                    testResults += `
                        <div style="background: rgba(239,68,68,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>‚ùå ${api.name}</strong><br>
                            ÈåØË™§: ${errorMsg}<br>
                            <small style="opacity: 0.8;">${api.url}</small>
                        </div>
                    `;
                }
            }
            
            testResults += `
                <br>
                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                    <strong>üí° Ë™™ÊòéÔºö</strong><br>
                    ‚Ä¢ ‚úÖ Ë°®Á§∫APIÂèØ‰ª•Ê≠£Â∏∏Ë®™Âïè<br>
                    ‚Ä¢ ‚ùå Ë°®Á§∫ÊúâCORSÈôêÂà∂ÊàñÂÖ∂‰ªñÂïèÈ°å<br>
                    ‚Ä¢ Â¶ÇÊûúÈÉΩÂ§±ÊïóÔºåÂèØËÉΩÈúÄË¶Å‰ΩøÁî®‰ª£ÁêÜÊúçÂãôÊàñÂæåÁ´ØAPI
                </div>
                </div>
            `;
            
            resultsDiv.innerHTML = testResults;
        }
        
        // Ê∏¨Ë©¶CORS‰ª£ÁêÜÊúçÂãô
        async function testCORSProxy() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Ê≠£Âú®Ê∏¨Ë©¶‰ª£ÁêÜÊúçÂãô...
                </div>
            `;
            
            const proxyServices = [
                {
                    name: 'AllOrigins',
                    getUrl: (target) => `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`
                },
                {
                    name: 'CORS Anywhere (ÈúÄË¶ÅÂïüÁî®)',
                    getUrl: (target) => `https://cors-anywhere.herokuapp.com/${target}`
                },
                {
                    name: 'Public CORS Proxy',
                    getUrl: (target) => `https://corsproxy.io/?${encodeURIComponent(target)}`
                }
            ];
            
            const targetUrl = 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json';
            let testResults = '<div class="station-card"><h3>üåê CORS‰ª£ÁêÜÊúçÂãôÊ∏¨Ë©¶</h3><br>';
            
            for (const proxy of proxyServices) {
                try {
                    const proxyUrl = proxy.getUrl(targetUrl);
                    console.log(`Ê∏¨Ë©¶ ${proxy.name}: ${proxyUrl}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ÁßíË∂ÖÊôÇ
                    
                    const response = await fetch(proxyUrl, {
                        signal: controller.signal,
                        method: 'GET'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        let data = await response.text();
                        
                        // AllOriginsÂåÖË£ùÊ†ºÂºè
                        if (proxy.name === 'AllOrigins') {
                            const parsed = JSON.parse(data);
                            data = parsed.contents;
                        }
                        
                        const jsonData = JSON.parse(data);
                        const dataLength = Array.isArray(jsonData) ? jsonData.length : Object.keys(jsonData).length;
                        
                        testResults += `
                            <div style="background: rgba(16,185,129,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #10b981;">
                                <strong>‚úÖ ${proxy.name}</strong><br>
                                ÁãÄÊÖã: ÊàêÂäüÁç≤ÂèñË≥áÊñô<br>
                                Ë≥áÊñôÁ≠ÜÊï∏: ${dataLength}<br>
                                <button onclick="useProxy('${proxy.name}', '${proxyUrl}')" style="
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    margin-top: 8px;
                                    font-size: 12px;
                                ">‰ΩøÁî®Ê≠§‰ª£ÁêÜ</button>
                            </div>
                        `;
                        
                        window.workingProxyService = proxy;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error(`‚ùå ${proxy.name} Â§±Êïó:`, error);
                    
                    let errorMsg = error.message;
                    if (error.name === 'AbortError') {
                        errorMsg = 'Ë´ãÊ±ÇË∂ÖÊôÇ (10Áßí)';
                    }
                    
                    testResults += `
                        <div style="background: rgba(239,68,68,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>‚ùå ${proxy.name}</strong><br>
                            ÈåØË™§: ${errorMsg}
                        </div>
                    `;
                }
            }
            
            testResults += `
                <br>
                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                    <strong>üí° ‰ΩøÁî®Ë™™ÊòéÔºö</strong><br>
                    ‚Ä¢ ‰ª£ÁêÜÊúçÂãôÂèØ‰ª•ÁπûÈÅéCORSÈôêÂà∂<br>
                    ‚Ä¢ ÊâæÂà∞ÂèØÁî®ÁöÑ‰ª£ÁêÜÂæåÔºåÈªûÈÅ∏„Äå‰ΩøÁî®Ê≠§‰ª£ÁêÜ„Äç<br>
                    ‚Ä¢ ‰πãÂæåÁöÑÊêúÂ∞ãÊúÉËá™Âãï‰ΩøÁî®Ë©≤‰ª£ÁêÜÊúçÂãô
                </div>
                </div>
            `;
            
            resultsDiv.innerHTML = testResults;
        }
        
        // È°ØÁ§∫Ëß£Ê±∫ÊñπÊ°à
        function showSolutions() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="station-card">
                    <h3>üí° CORSÂïèÈ°åËß£Ê±∫ÊñπÊ°à</h3>
                    <br>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px;">üö´ ÂïèÈ°åÂéüÂõ†Ôºö</h4>
                        <p style="line-height: 1.5; opacity: 0.9;">
                        ÁÄèË¶ΩÂô®ÁöÑCORS (Ë∑®ÂüüË≥áÊ∫êÂÖ±‰∫´) ÂÆâÂÖ®ÊîøÁ≠ñÈòªÊ≠¢Á∂≤È†ÅÁõ¥Êé•Ë®™Âïè‰∏çÂêåÁ∂≤ÂüüÁöÑAPI„ÄÇ
                        ÈÄôÊòØÊ≠£Â∏∏ÁöÑÂÆâÂÖ®Ê©üÂà∂ÔºåÊîøÂ∫úAPIÈÄöÂ∏∏ÈÉΩÊúâÈÄôÂÄãÈôêÂà∂„ÄÇ
                        </p>
                    </div>
                    
                    <div style="background: rgba(16,185,129,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #10b981;">
                        <h4 style="margin-bottom: 12px;">‚úÖ ÊñπÊ°à1Ôºö‰ΩøÁî®VercelÈÉ®ÁΩ≤ (Êé®Ëñ¶)</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        ‚Ä¢ ÂÖçË≤ª„ÄÅÁ∞°ÂñÆ„ÄÅÁÑ°ÈúÄÁ∂≠Ë≠∑‰º∫ÊúçÂô®<br>
                        ‚Ä¢ Ëá™ÂãïËôïÁêÜCORSÂïèÈ°å<br>
                        ‚Ä¢ ÂÖ®ÁêÉCDNÂä†ÈÄü
                        </p>
                        <button onclick="window.open('https://vercel.com', '_blank')" style="
                            background: #000; 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 4px; 
                            cursor: pointer;
                            font-size: 12px;
                        ">ÂâçÂæÄ Vercel Á∂≤Á´ô</button>
                    </div>
                    
                    <div style="background: rgba(59,130,246,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                        <h4 style="margin-bottom: 12px;">üñ•Ô∏è ÊñπÊ°à2ÔºöÊú¨Âú∞Node.js‰º∫ÊúçÂô®</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        ‚Ä¢ ÂÆåÂÖ®ÊéßÂà∂ÔºåÈÅ©ÂêàÈñãÁôºÊ∏¨Ë©¶<br>
                        ‚Ä¢ ÈúÄË¶ÅÂÆâË£ùNode.jsÂíåÁõ∏ÈóúÂ•ó‰ª∂<br>
                        ‚Ä¢ Êú¨Âú∞ÈÅãË°åÔºåÈÄüÂ∫¶Âø´
                        </p>
                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        npm install express cors node-fetch@2<br>
                        node server.js
                        </div>
                    </div>
                    
                    <div style="background: rgba(245,158,11,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                        <h4 style="margin-bottom: 12px;">üì± ÊñπÊ°à3ÔºöÂéüÁîüAppÊñπÂºè</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        ‚Ä¢ Â∞áPWAÂÆâË£ùÂà∞Ê°åÈù¢<br>
                        ‚Ä¢ Êüê‰∫õÊÉÖÊ≥Å‰∏ãCORSÈôêÂà∂ÊúÉÊ∏õÂ∞ë<br>
                        ‚Ä¢ ‰ΩøÁî®SafariÁöÑ"Âä†ÂÖ•‰∏ªÁï´Èù¢"ÂäüËÉΩ
                        </p>
                    </div>
                    
                    <div style="background: rgba(139,92,246,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #8b5cf6;">
                        <h4 style="margin-bottom: 12px;">üîß ÊñπÊ°à4ÔºöËá™Â∑±ÁöÑAPI‰º∫ÊúçÂô®</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        Â¶ÇÊûú‰Ω†Â∑≤Á∂ìÊúâËá™Â∑±ÁöÑAPI‰º∫ÊúçÂô®ÔºåÂèØ‰ª•Âú®‰∏äÊñπËº∏ÂÖ•Á∂≤ÂùÄÔºö<br>
                        ‰æãÂ¶ÇÔºö<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">
                        https://your-domain.com/api/ubike</code>
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="useTestData('ÊùøÊ©ãËªäÁ´ô')" style="
                            background: #10b981; 
                            color: white; 
                            border: none; 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            cursor: pointer;
                            font-size: 14px;
                        ">üß™ ÂÖàÁî®Ê∏¨Ë©¶Ë≥áÊñôÈ´îÈ©óÂäüËÉΩ</button>
                    </div>
                </div>
            `;
        }
        
        // Ë®≠ÂÆöËá™Ë®ÇAPI
        function setCustomAPI() {
            const customUrl = document.getElementById('customApiUrl').value.trim();
            if (!customUrl) {
                alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑAPIÁ∂≤ÂùÄ');
                return;
            }
            
            // Á∞°ÂñÆÁöÑURLÈ©óË≠â
            try {
                new URL(customUrl);
                window.customApiUrl = customUrl;
                alert('‚úÖ Â∑≤Ë®≠ÂÆöËá™Ë®ÇAPIÔºÅ\nÁèæÂú®ÂèØ‰ª•ÂòóË©¶ÊêúÂ∞ãÁ´ôÈªû„ÄÇ');
                document.getElementById('customApiUrl').value = '';
            } catch (error) {
                alert('‚ùå ÁÑ°ÊïàÁöÑÁ∂≤ÂùÄÊ†ºÂºèÔºåË´ãÊ™¢Êü•ÂæåÈáçÊñ∞Ëº∏ÂÖ•„ÄÇ');
            }
        }
        
        // È°ØÁ§∫Á´ôÈªûË≥áË®ä
        function displayStations(stations) {
            const resultsDiv = document.getElementById('results');
            
            if (stations.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        Êâæ‰∏çÂà∞ÂåÖÂê´„Äå${lastSearchKeyword}„ÄçÁöÑÁ´ôÈªû<br>
                        Ë´ãÂòóË©¶‰ΩøÁî®ÂÖ∂‰ªñÈóúÈçµÂ≠ó
                    </div>
                `;
                return;
            }
            
            const stationsHTML = stations.map(station => `
                <div class="station-card">
                    <div class="station-name">
                        üìç ${station.sna || 'Êú™Áü•Á´ôÈªû'}
                    </div>
                    
                    <div class="station-info">
                        <div class="info-item">
                            <div class="info-number bikes-available">${station.sbi || 0}</div>
                            <div class="info-label">ÂèØÂÄüËªäËºõ</div>
                        </div>
                        <div class="info-item">
                            <div class="info-number spaces-available">${station.bemp || 0}</div>
                            <div class="info-label">ÂèØÈÇÑÁ©∫‰Ωç</div>
                        </div>
                    </div>
                    
                    <div class="station-address">
                        üìç ${station.ar || 'Âú∞ÂùÄË≥áË®äÊú™Êèê‰æõ'}
                    </div>
                    
                    ${station.act === '0' ? '<div style="color: #ef4444; font-weight: 600; margin-top: 12px; text-align: center;">‚ö†Ô∏è Á´ôÈªûÊö´ÂÅúÁáüÈÅã</div>' : ''}
                </div>
            `).join('');
            
            resultsDiv.innerHTML = stationsHTML + `
                <div class="last-update">
                    ÊúÄÂæåÊõ¥Êñ∞Ôºö${new Date().toLocaleString('zh-TW')}
                </div>
            `;
        }
        
        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // EnterÈçµÊêúÂ∞ã
        document.getElementById('stationSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStation();
            }
        });
        
        // PWAÂÆâË£ùÊèêÁ§∫
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // È°ØÁ§∫ÂÆâË£ùÊèêÁ§∫
            if (!localStorage.getItem('pwaInstallPromptShown')) {
                setTimeout(() => {
                    if (confirm('Ë¶ÅÂ∞áÊ≠§ÊáâÁî®Á®ãÂºèÂÆâË£ùÂà∞ÊÇ®ÁöÑË£ùÁΩÆÂóéÔºü')) {
                        installPWA();
                    }
                    localStorage.setItem('pwaInstallPromptShown', 'true');
                }, 3000);
            }
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            }
        }
        
        // Ëá™ÂãïÈáçÊñ∞Êï¥ÁêÜ (ÊØè30Áßí)
        setInterval(() => {
            if (lastSearchKeyword && currentStations.length > 0) {
                refreshData();
            }
        }, 30000);
        
        // È†êË®≠ÊêúÂ∞ã‰∏Ä‰∫õÂ∏∏Ë¶ãÁ´ôÈªû‰ΩúÁÇ∫Á§∫ÁØÑ
        window.addEventListener('load', () => {
            // 3ÁßíÂæåËá™ÂãïÊêúÂ∞ãÊùøÊ©ãËªäÁ´ô‰ΩúÁÇ∫Á§∫ÁØÑ
            setTimeout(() => {
                if (!lastSearchKeyword) {
                    document.getElementById('stationSearch').value = 'ÊùøÊ©ãËªäÁ´ô';
                    searchStation();
                }
            }, 1000);
        });
    </script>
</body>
</html>