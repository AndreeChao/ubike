<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <title>UBike 2.0 ç«™é»ç›£æ§</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVUJpa2UgMi4wIOermOmBuOeboeaOp+WZqCIsInNob3J0X25hbWUiOiJVQmlrZSDnm6HmjqciLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzI1NjNlYiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdkbWxsZDBKdmVEMGlNQ0F3SURFME5DQXhORFFpSUdobGJXNXpQU0pvZEhSd2N6b3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4d1lYUm9JR1E5SW0wME1TNHhOemczTGpNeU9EQXVNREkzTGpVMU5ERXdMamMzTVRreE9TNDJOemcyTVRBdU56Y3hPUzQzTkRrM09TNHhOalU1T0M0eE5qVTVPQzQwTnpZMk1UQXVORGszTnpBdU1UYzFPVGszTGpNeU9EUXVNREkzZXlJZ1ptbHNiRDBpSXpJMU5qTmxZaUl2UGp4d1lYUm9JR1E5SW0wNU1pNDVOell5T0RBdU1ESTNMakUwTVRrd01TNHdPRE14TnpBdU1UYzFPVGsyTGprNU16WTRPUzR4TkRFNU1qQXVNRGswTWpBdU1EazBNakF1TWpreE56Y3VNekEzWmpFM0xqTXdObVExTWk0ek5EVTFPREZ1TWpRdU1qYzJNVEl4TGpjNE56YzFNakkxTGpnek1EVTFPREF1TURJM2VpSWdabWxzYkQwaUl6WmlabU16WmlJdlBqeHdZWFJvSUdROUltMHhNRE11TkRBeE1qQXVNRGs1TXpjdU9UUXlNekEzTGpNME5qWkVPRFF1TkRJek1qQXVNREkzVWpBdU1ESTNNRE11TkRBeGVpSWdabWxzYkQwaUkwWkdSa1pHUmlJdlBqd3ZjM1puUGc9PSIsInNpemVzIjoiMTQ0eDE0NCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- ç¦æ­¢ç¸®æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header .subtitle {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .container {
            flex: 1;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
        }
        
        .search-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .search-input {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
        }
        
        .search-input::placeholder {
            color: #666;
        }
        
        .search-btn {
            width: 100%;
            padding: 16px;
            background: #10b981;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16,185,129,0.3);
        }
        
        .search-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        .station-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .station-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .station-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .info-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 16px;
            border-radius: 12px;
        }
        
        .info-number {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .info-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .bikes-available {
            color: #10b981;
        }
        
        .spaces-available {
            color: #3b82f6;
        }
        
        .station-address {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }
        
        .error {
            background: rgba(239,68,68,0.9);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.8;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .last-update {
            text-align: center;
            opacity: 0.6;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: #10b981;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(16,185,129,0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(16,185,129,0.5);
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .station-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš² UBike 2.0 ç›£æ§</h1>
        <div class="subtitle">æ–°åŒ—å¸‚å…¬å…±è‡ªè¡Œè»Šå³æ™‚è³‡è¨Š</div>
    </div>
    
    <div class="container">
        <div class="search-section">
            <input type="text" class="search-input" id="stationSearch" placeholder="è¼¸å…¥ç«™é»åç¨± (ä¾‹å¦‚: æ¿æ©‹è»Šç«™)">
            <button class="search-btn" onclick="searchStation()">ğŸ” æœå°‹ç«™é»</button>
            
            <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="testAPI()" style="
                    flex: 1;
                    padding: 12px;
                    background: #3b82f6;
                    border: none;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    cursor: pointer;
                ">ğŸ”§ æ¸¬è©¦APIé€£ç·š</button>
                
                <button onclick="showSolutions()" style="
                    flex: 1;
                    padding: 12px;
                    background: #f59e0b;
                    border: none;
                    border-radius: 8px;
                    color: white;
                    font-size: 14px;
                    cursor: pointer;
                ">ğŸ’¡ æŸ¥çœ‹è§£æ±ºæ–¹æ¡ˆ</button>
            </div>
            
            <div style="margin-top: 12px;">
                <input type="text" placeholder="å¦‚æœä½ æœ‰è‡ªå·±çš„APIç¶²å€ï¼Œè«‹è¼¸å…¥..." id="customApiUrl" style="
                    width: 70%;
                    padding: 10px;
                    border: none;
                    border-radius: 6px 0 0 6px;
                    font-size: 14px;
                ">
                <button onclick="setCustomAPI()" style="
                    width: 30%;
                    padding: 10px;
                    background: #10b981;
                    border: none;
                    border-radius: 0 6px 6px 0;
                    color: white;
                    font-size: 14px;
                    cursor: pointer;
                ">è¨­å®š</button>
            </div>
        </div>
        
        <div id="results"></div>
    </div>
    
    <button class="refresh-btn" onclick="refreshData()" title="é‡æ–°æ•´ç†">
        <span id="refreshIcon">ğŸ”„</span>
    </button>
    
    <script>
        let currentStations = [];
        let lastSearchKeyword = '';
        
        // æœå°‹ç«™é»
        async function searchStation() {
            const keyword = document.getElementById('stationSearch').value.trim();
            if (!keyword) {
                showError('è«‹è¼¸å…¥ç«™é»åç¨±');
                return;
            }
            
            lastSearchKeyword = keyword;
            await fetchStationData(keyword);
        }
        
        // é‡æ–°æ•´ç†è³‡æ–™
        async function refreshData() {
            if (!lastSearchKeyword) return;
            
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            await fetchStationData(lastSearchKeyword);
            
            setTimeout(() => {
                refreshIcon.style.animation = '';
            }, 1000);
        }
        
        // ç²å–ç«™é»è³‡æ–™ (æ”¯æ´è‡ªè¨‚API)
        async function fetchStationData(keyword) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    æœå°‹ä¸­...
                </div>
            `;
            
            try {
                let data;
                let response;
                let apiUrl;
                
                // å„ªå…ˆä½¿ç”¨è‡ªè¨‚API
                if (window.customApiUrl) {
                    apiUrl = window.customApiUrl;
                    console.log('ä½¿ç”¨è‡ªè¨‚API:', apiUrl);
                }
                // å…¶æ¬¡ä½¿ç”¨æ‰¾åˆ°çš„å¯ç”¨API
                else if (window.workingApiUrl) {
                    apiUrl = window.workingApiUrl;
                    console.log('ä½¿ç”¨æ¸¬è©¦é€šéçš„API:', apiUrl);
                }
                // æœ€å¾Œå˜—è©¦ç›´æ¥è¨ªå•
                else {
                    apiUrl = 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json';
                    console.log('å˜—è©¦ç›´æ¥APIè¨ªå•:', apiUrl);
                }
                
                response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // ç¢ºä¿dataæ˜¯é™£åˆ—æ ¼å¼
                if (!Array.isArray(data)) {
                    throw new Error('APIå›æ‡‰æ ¼å¼ä¸æ­£ç¢º - éœ€è¦é™£åˆ—æ ¼å¼');
                }
                
                console.log(`æˆåŠŸç²å– ${data.length} ç­†ç«™é»è³‡æ–™`);
                
                // ç¯©é¸åŒ…å«é—œéµå­—çš„ç«™é»
                const filteredStations = data.filter(station => 
                    station.sna && station.sna.includes(keyword)
                );
                
                currentStations = filteredStations;
                displayStations(filteredStations);
                
            } catch (error) {
                console.error('API Error:', error);
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤ºä¸åŒçš„è§£æ±ºå»ºè­°
                let errorMessage = '';
                let suggestions = '';
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    errorMessage = 'CORSè·¨åŸŸé™åˆ¶æˆ–ç¶²è·¯é€£ç·šå•é¡Œ';
                    suggestions = `
                        <strong>ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>
                        1. é»é¸ã€ŒğŸ’¡ æŸ¥çœ‹è§£æ±ºæ–¹æ¡ˆã€äº†è§£è©³ç´°èªªæ˜<br>
                        2. ä½¿ç”¨Vercelç­‰æœå‹™éƒ¨ç½²è‡ªå·±çš„APIä»£ç†<br>
                        3. æš«æ™‚ä½¿ç”¨æ¸¬è©¦è³‡æ–™é«”é©—åŠŸèƒ½
                    `;
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `APIä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${error.message}`;
                    suggestions = `
                        <strong>ğŸ’¡ å¯èƒ½åŸå› ï¼š</strong><br>
                        â€¢ APIä¼ºæœå™¨æš«æ™‚ç„¡æ³•ä½¿ç”¨<br>
                        â€¢ ç¶²å€è¨­å®šä¸æ­£ç¢º<br>
                        â€¢ APIæ ¼å¼å·²è®Šæ›´
                    `;
                } else {
                    errorMessage = error.message;
                    suggestions = 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–APIè¨­å®š';
                }
                
                showError(`
                    <strong>ğŸš« ç„¡æ³•ç²å–å³æ™‚è³‡æ–™</strong><br><br>
                    éŒ¯èª¤åŸå› : ${errorMessage}<br><br>
                    ${suggestions}<br><br>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;">
                        <button onclick="showSolutions()" style="
                            background: #f59e0b; 
                            color: white; 
                            border: none; 
                            padding: 10px 16px; 
                            border-radius: 6px; 
                            cursor: pointer;
                            font-size: 13px;
                        ">ğŸ’¡ æŸ¥çœ‹è§£æ±ºæ–¹æ¡ˆ</button>
                        
                        <button onclick="useTestData('${keyword}')" style="
                            background: #10b981; 
                            color: white; 
                            border: none; 
                            padding: 10px 16px; 
                            border-radius: 6px; 
                            cursor: pointer;
                            font-size: 13px;
                        ">ğŸ§ª ä½¿ç”¨æ¸¬è©¦è³‡æ–™</button>
                    </div>
                `);
            }
        }
        
        // ä½¿ç”¨æ¸¬è©¦è³‡æ–™
        function useTestData(keyword) {
            const data = generateTestData(keyword);
            const filteredStations = data.filter(station => 
                station.sna && station.sna.includes(keyword)
            );
            
            currentStations = filteredStations;
            displayStations(filteredStations);
        }
        
        // ç”Ÿæˆæ¸¬è©¦è³‡æ–™ (æ¨¡æ“¬çœŸå¯¦API)
        function generateTestData(keyword) {
            const testStations = [
                {
                    sno: "500101001",
                    sna: "YouBike2.0_æ¿æ©‹è»Šç«™",
                    tot: 40,
                    sbi: 12,
                    bemp: 28,
                    sarea: "æ¿æ©‹å€",
                    ar: "æ–°åŒ—å¸‚æ¿æ©‹å€ç¸£æ°‘å¤§é“äºŒæ®µ7è™Ÿ(æ¿æ©‹è»Šç«™)",
                    act: "1"
                },
                {
                    sno: "500101002", 
                    sna: "YouBike2.0_æ–°åŸ”ç«™1è™Ÿå‡ºå£",
                    tot: 32,
                    sbi: 8,
                    bemp: 24,
                    sarea: "æ¿æ©‹å€",
                    ar: "æ–°åŒ—å¸‚æ¿æ©‹å€æ°‘ç”Ÿè·¯ä¸‰æ®µ17è™Ÿå‰æ–¹",
                    act: "1"
                },
                {
                    sno: "500101003",
                    sna: "YouBike2.0_åºœä¸­ç«™",
                    tot: 28,
                    sbi: 5,
                    bemp: 23,
                    sarea: "æ¿æ©‹å€", 
                    ar: "æ–°åŒ—å¸‚æ¿æ©‹å€åºœä¸­è·¯29è™Ÿå°é¢",
                    act: "1"
                },
                {
                    sno: "500101004",
                    sna: "YouBike2.0_ä¸‰é‡ç«™",
                    tot: 36,
                    sbi: 15,
                    bemp: 21,
                    sarea: "ä¸‰é‡å€",
                    ar: "æ–°åŒ—å¸‚ä¸‰é‡å€é‡æ–°è·¯å››æ®µ17è™Ÿå‰",
                    act: "1"
                },
                {
                    sno: "500101005",
                    sna: "YouBike2.0_æ–°èŠç«™",
                    tot: 30,
                    sbi: 7,
                    bemp: 23,
                    sarea: "æ–°èŠå€",
                    ar: "æ–°åŒ—å¸‚æ–°èŠå€æ–°æ¨¹è·¯108è™Ÿå°é¢",
                    act: "1"
                }
            ];
            
            return testStations;
        }
        
        // æ¸¬è©¦APIé€£ç·š
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    æ­£åœ¨æ¸¬è©¦APIé€£ç·š...
                </div>
            `;
            
            const apiUrls = [
                {
                    name: 'æ–°åŒ—å¸‚å®˜æ–¹API',
                    url: 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json'
                },
                {
                    name: 'æ”¿åºœè³‡æ–™é–‹æ”¾å¹³å°',
                    url: 'https://data.gov.tw/api/v1/rest/datastore/382000000A-000352-001'
                },
                {
                    name: 'YouBikeå®˜æ–¹API',
                    url: 'https://apis.youbike.com.tw/json/station-yb2.json'
                }
            ];
            
            let testResults = '<div class="station-card"><h3>ğŸ”§ APIé€£ç·šæ¸¬è©¦çµæœ</h3><br>';
            
            for (const api of apiUrls) {
                try {
                    console.log(`æ¸¬è©¦ ${api.name}: ${api.url}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ™‚
                    
                    const response = await fetch(api.url, {
                        signal: controller.signal,
                        mode: 'cors',
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    const status = response.status;
                    const statusText = response.statusText;
                    
                    if (response.ok) {
                        const data = await response.json();
                        const dataLength = Array.isArray(data) ? data.length : Object.keys(data).length;
                        
                        testResults += `
                            <div style="background: rgba(16,185,129,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #10b981;">
                                <strong>âœ… ${api.name}</strong><br>
                                ç‹€æ…‹: ${status} ${statusText}<br>
                                è³‡æ–™ç­†æ•¸: ${dataLength}<br>
                                <small style="opacity: 0.8;">${api.url}</small>
                            </div>
                        `;
                        
                        // å¦‚æœæˆåŠŸï¼Œä½¿ç”¨é€™å€‹API
                        if (Array.isArray(data) && data.length > 0) {
                            console.log(`âœ… æ‰¾åˆ°å¯ç”¨çš„API: ${api.name}`);
                            window.workingApiUrl = api.url;
                        }
                    } else {
                        throw new Error(`HTTP ${status}: ${statusText}`);
                    }
                } catch (error) {
                    console.error(`âŒ ${api.name} å¤±æ•—:`, error);
                    
                    let errorMsg = error.message;
                    if (error.name === 'AbortError') {
                        errorMsg = 'è«‹æ±‚è¶…æ™‚ (5ç§’)';
                    } else if (error.message.includes('CORS')) {
                        errorMsg = 'CORSè·¨åŸŸé™åˆ¶';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMsg = 'ç¶²è·¯é€£ç·šå¤±æ•—æˆ–CORSé™åˆ¶';
                    }
                    
                    testResults += `
                        <div style="background: rgba(239,68,68,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>âŒ ${api.name}</strong><br>
                            éŒ¯èª¤: ${errorMsg}<br>
                            <small style="opacity: 0.8;">${api.url}</small>
                        </div>
                    `;
                }
            }
            
            testResults += `
                <br>
                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                    <strong>ğŸ’¡ èªªæ˜ï¼š</strong><br>
                    â€¢ âœ… è¡¨ç¤ºAPIå¯ä»¥æ­£å¸¸è¨ªå•<br>
                    â€¢ âŒ è¡¨ç¤ºæœ‰CORSé™åˆ¶æˆ–å…¶ä»–å•é¡Œ<br>
                    â€¢ å¦‚æœéƒ½å¤±æ•—ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä»£ç†æœå‹™æˆ–å¾Œç«¯API
                </div>
                </div>
            `;
            
            resultsDiv.innerHTML = testResults;
        }
        
        // æ¸¬è©¦CORSä»£ç†æœå‹™
        async function testCORSProxy() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    æ­£åœ¨æ¸¬è©¦ä»£ç†æœå‹™...
                </div>
            `;
            
            const proxyServices = [
                {
                    name: 'AllOrigins',
                    getUrl: (target) => `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`
                },
                {
                    name: 'CORS Anywhere (éœ€è¦å•Ÿç”¨)',
                    getUrl: (target) => `https://cors-anywhere.herokuapp.com/${target}`
                },
                {
                    name: 'Public CORS Proxy',
                    getUrl: (target) => `https://corsproxy.io/?${encodeURIComponent(target)}`
                }
            ];
            
            const targetUrl = 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json';
            let testResults = '<div class="station-card"><h3>ğŸŒ CORSä»£ç†æœå‹™æ¸¬è©¦</h3><br>';
            
            for (const proxy of proxyServices) {
                try {
                    const proxyUrl = proxy.getUrl(targetUrl);
                    console.log(`æ¸¬è©¦ ${proxy.name}: ${proxyUrl}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ™‚
                    
                    const response = await fetch(proxyUrl, {
                        signal: controller.signal,
                        method: 'GET'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        let data = await response.text();
                        
                        // AllOriginsåŒ…è£æ ¼å¼
                        if (proxy.name === 'AllOrigins') {
                            const parsed = JSON.parse(data);
                            data = parsed.contents;
                        }
                        
                        const jsonData = JSON.parse(data);
                        const dataLength = Array.isArray(jsonData) ? jsonData.length : Object.keys(jsonData).length;
                        
                        testResults += `
                            <div style="background: rgba(16,185,129,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #10b981;">
                                <strong>âœ… ${proxy.name}</strong><br>
                                ç‹€æ…‹: æˆåŠŸç²å–è³‡æ–™<br>
                                è³‡æ–™ç­†æ•¸: ${dataLength}<br>
                                <button onclick="useProxy('${proxy.name}', '${proxyUrl}')" style="
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    margin-top: 8px;
                                    font-size: 12px;
                                ">ä½¿ç”¨æ­¤ä»£ç†</button>
                            </div>
                        `;
                        
                        window.workingProxyService = proxy;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error(`âŒ ${proxy.name} å¤±æ•—:`, error);
                    
                    let errorMsg = error.message;
                    if (error.name === 'AbortError') {
                        errorMsg = 'è«‹æ±‚è¶…æ™‚ (10ç§’)';
                    }
                    
                    testResults += `
                        <div style="background: rgba(239,68,68,0.2); padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>âŒ ${proxy.name}</strong><br>
                            éŒ¯èª¤: ${errorMsg}
                        </div>
                    `;
                }
            }
            
            testResults += `
                <br>
                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                    <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                    â€¢ ä»£ç†æœå‹™å¯ä»¥ç¹éCORSé™åˆ¶<br>
                    â€¢ æ‰¾åˆ°å¯ç”¨çš„ä»£ç†å¾Œï¼Œé»é¸ã€Œä½¿ç”¨æ­¤ä»£ç†ã€<br>
                    â€¢ ä¹‹å¾Œçš„æœå°‹æœƒè‡ªå‹•ä½¿ç”¨è©²ä»£ç†æœå‹™
                </div>
                </div>
            `;
            
            resultsDiv.innerHTML = testResults;
        }
        
        // é¡¯ç¤ºè§£æ±ºæ–¹æ¡ˆ
        function showSolutions() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="station-card">
                    <h3>ğŸ’¡ CORSå•é¡Œè§£æ±ºæ–¹æ¡ˆ</h3>
                    <br>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px;">ğŸš« å•é¡ŒåŸå› ï¼š</h4>
                        <p style="line-height: 1.5; opacity: 0.9;">
                        ç€è¦½å™¨çš„CORS (è·¨åŸŸè³‡æºå…±äº«) å®‰å…¨æ”¿ç­–é˜»æ­¢ç¶²é ç›´æ¥è¨ªå•ä¸åŒç¶²åŸŸçš„APIã€‚
                        é€™æ˜¯æ­£å¸¸çš„å®‰å…¨æ©Ÿåˆ¶ï¼Œæ”¿åºœAPIé€šå¸¸éƒ½æœ‰é€™å€‹é™åˆ¶ã€‚
                        </p>
                    </div>
                    
                    <div style="background: rgba(16,185,129,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #10b981;">
                        <h4 style="margin-bottom: 12px;">âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨Verceléƒ¨ç½² (æ¨è–¦)</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        â€¢ å…è²»ã€ç°¡å–®ã€ç„¡éœ€ç¶­è­·ä¼ºæœå™¨<br>
                        â€¢ è‡ªå‹•è™•ç†CORSå•é¡Œ<br>
                        â€¢ å…¨çƒCDNåŠ é€Ÿ
                        </p>
                        <button onclick="window.open('https://vercel.com', '_blank')" style="
                            background: #000; 
                            color: white; 
                            border: none; 
                            padding: 8px 16px; 
                            border-radius: 4px; 
                            cursor: pointer;
                            font-size: 12px;
                        ">å‰å¾€ Vercel ç¶²ç«™</button>
                    </div>
                    
                    <div style="background: rgba(59,130,246,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                        <h4 style="margin-bottom: 12px;">ğŸ–¥ï¸ æ–¹æ¡ˆ2ï¼šæœ¬åœ°Node.jsä¼ºæœå™¨</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        â€¢ å®Œå…¨æ§åˆ¶ï¼Œé©åˆé–‹ç™¼æ¸¬è©¦<br>
                        â€¢ éœ€è¦å®‰è£Node.jså’Œç›¸é—œå¥—ä»¶<br>
                        â€¢ æœ¬åœ°é‹è¡Œï¼Œé€Ÿåº¦å¿«
                        </p>
                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        npm install express cors node-fetch@2<br>
                        node server.js
                        </div>
                    </div>
                    
                    <div style="background: rgba(245,158,11,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                        <h4 style="margin-bottom: 12px;">ğŸ“± æ–¹æ¡ˆ3ï¼šåŸç”ŸAppæ–¹å¼</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        â€¢ å°‡PWAå®‰è£åˆ°æ¡Œé¢<br>
                        â€¢ æŸäº›æƒ…æ³ä¸‹CORSé™åˆ¶æœƒæ¸›å°‘<br>
                        â€¢ ä½¿ç”¨Safariçš„"åŠ å…¥ä¸»ç•«é¢"åŠŸèƒ½
                        </p>
                    </div>
                    
                    <div style="background: rgba(139,92,246,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #8b5cf6;">
                        <h4 style="margin-bottom: 12px;">ğŸ”§ æ–¹æ¡ˆ4ï¼šè‡ªå·±çš„APIä¼ºæœå™¨</h4>
                        <p style="line-height: 1.5; margin-bottom: 12px;">
                        å¦‚æœä½ å·²ç¶“æœ‰è‡ªå·±çš„APIä¼ºæœå™¨ï¼Œå¯ä»¥åœ¨ä¸Šæ–¹è¼¸å…¥ç¶²å€ï¼š<br>
                        ä¾‹å¦‚ï¼š<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">
                        https://your-domain.com/api/ubike</code>
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="useTestData('æ¿æ©‹è»Šç«™')" style="
                            background: #10b981; 
                            color: white; 
                            border: none; 
                            padding: 12px 24px; 
                            border-radius: 8px; 
                            cursor: pointer;
                            font-size: 14px;
                        ">ğŸ§ª å…ˆç”¨æ¸¬è©¦è³‡æ–™é«”é©—åŠŸèƒ½</button>
                    </div>
                </div>
            `;
        }
        
        // è¨­å®šè‡ªè¨‚API
        function setCustomAPI() {
            const customUrl = document.getElementById('customApiUrl').value.trim();
            if (!customUrl) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„APIç¶²å€');
                return;
            }
            
            // ç°¡å–®çš„URLé©—è­‰
            try {
                new URL(customUrl);
                window.customApiUrl = customUrl;
                alert('âœ… å·²è¨­å®šè‡ªè¨‚APIï¼\nç¾åœ¨å¯ä»¥å˜—è©¦æœå°‹ç«™é»ã€‚');
                document.getElementById('customApiUrl').value = '';
            } catch (error) {
                alert('âŒ ç„¡æ•ˆçš„ç¶²å€æ ¼å¼ï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°è¼¸å…¥ã€‚');
            }
        }
        
        // é¡¯ç¤ºç«™é»è³‡è¨Š
        function displayStations(stations) {
            const resultsDiv = document.getElementById('results');
            
            if (stations.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        æ‰¾ä¸åˆ°åŒ…å«ã€Œ${lastSearchKeyword}ã€çš„ç«™é»<br>
                        è«‹å˜—è©¦ä½¿ç”¨å…¶ä»–é—œéµå­—
                    </div>
                `;
                return;
            }
            
            const stationsHTML = stations.map(station => `
                <div class="station-card">
                    <div class="station-name">
                        ğŸ“ ${station.sna || 'æœªçŸ¥ç«™é»'}
                    </div>
                    
                    <div class="station-info">
                        <div class="info-item">
                            <div class="info-number bikes-available">${station.sbi || 0}</div>
                            <div class="info-label">å¯å€Ÿè»Šè¼›</div>
                        </div>
                        <div class="info-item">
                            <div class="info-number spaces-available">${station.bemp || 0}</div>
                            <div class="info-label">å¯é‚„ç©ºä½</div>
                        </div>
                    </div>
                    
                    <div class="station-address">
                        ğŸ“ ${station.ar || 'åœ°å€è³‡è¨Šæœªæä¾›'}
                    </div>
                    
                    ${station.act === '0' ? '<div style="color: #ef4444; font-weight: 600; margin-top: 12px; text-align: center;">âš ï¸ ç«™é»æš«åœç‡Ÿé‹</div>' : ''}
                </div>
            `).join('');
            
            resultsDiv.innerHTML = stationsHTML + `
                <div class="last-update">
                    æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleString('zh-TW')}
                </div>
            `;
        }
        
        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // Enteréµæœå°‹
        document.getElementById('stationSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStation();
            }
        });
        
        // PWAå®‰è£æç¤º
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // é¡¯ç¤ºå®‰è£æç¤º
            if (!localStorage.getItem('pwaInstallPromptShown')) {
                setTimeout(() => {
                    if (confirm('è¦å°‡æ­¤æ‡‰ç”¨ç¨‹å¼å®‰è£åˆ°æ‚¨çš„è£ç½®å—ï¼Ÿ')) {
                        installPWA();
                    }
                    localStorage.setItem('pwaInstallPromptShown', 'true');
                }, 3000);
            }
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            }
        }
        
        // è‡ªå‹•é‡æ–°æ•´ç† (æ¯30ç§’)
        setInterval(() => {
            if (lastSearchKeyword && currentStations.length > 0) {
                refreshData();
            }
        }, 30000);
        
        // é è¨­æœå°‹ä¸€äº›å¸¸è¦‹ç«™é»ä½œç‚ºç¤ºç¯„
        window.addEventListener('load', () => {
            // 3ç§’å¾Œè‡ªå‹•æœå°‹æ¿æ©‹è»Šç«™ä½œç‚ºç¤ºç¯„
            setTimeout(() => {
                if (!lastSearchKeyword) {
                    document.getElementById('stationSearch').value = 'æ¿æ©‹è»Šç«™';
                    searchStation();
                }
            }, 1000);
        });
    </script>
</body>
</html>